<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="css/bootstrap.css">
    <meta charset="UTF-8">
    <title>FlightChain</title>
    <script src="http://code.jquery.com/jquery-3.0.0.js"></script>
    <script src="js/bootstrap.js"></script>
</head>
<body>
<h1>FlightChain(tm)</h1>
Address to call from: <input type="text" id="AddressInput" value="0x0">
<input type="button" value="Log In" onclick="login()" />
<br />
<div class="panel-group" role="tablist" aria-multiselectable="true" id="methods"></div>
<div id="accounts">
    <table id="accounts-list" class="table table-bordered">
        <thead class="thead-dark">
            <tr>
                <th scope="col">#</th>
                <th scope="col">Account</th>
                <th scope="col">Balance</th>
            </tr>
        </thead>
        <tbody id="account-body"></tbody>
    </table>
</div>

<br>
<p id="out"></p>
</body>
<script src="https://cdn.jsdelivr.net/npm/web3@1.2.6/dist/web3.min.js"></script>
<script>

    const web3 = new Web3('http://localhost:8545');

    const contractAddr = "0x27A734E26C891f8897eEe94064bAedbe7387c245";
    const ABI = [{"inputs":[{"internalType":"string","name":"_name","type":"string"},{"internalType":"string","name":"_API","type":"string"},{"internalType":"string","name":"_addr","type":"string"}],"name":"addContract","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getContracts","outputs":[{"components":[{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"API","type":"string"},{"internalType":"string","name":"addr","type":"string"}],"internalType":"struct Main.Entry[]","name":"results","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"removeContract","outputs":[],"stateMutability":"nonpayable","type":"function"}];
    const myContract = new web3.eth.Contract(ABI, contractAddr);

    let callerAddr;

    let out = document.getElementById("out");

    let contracts = {};

    function generateInput(methodName, varName, type) {
        let field = document.createElement("input");
        field.type = "text";
        field.placeholder = type + ": " + varName;
        field.id = methodName + "_" + varName;
        return field;
    }

    function login() {
        web3.eth.personal.unlockAccount(document.getElementById("AddressInput").value, "", 0);
        callerAddr = document.getElementById("AddressInput").value;
        document.getElementById("methods").innerHTML = "";
        myContract.methods.getContracts().call().then((Result) => {
            contracts["Main"]= {name: "Main", ABI: ABI, address: contractAddr};
            console.log(Result);
            Result.forEach(contract => {
                contracts[contract[0]] = {name: contract[0], ABI: JSON.parse(contract[1]), address: contract[2]};
            });
            generateSections(Result);
        });
        ABI.forEach(method => generateCaller(method, document.getElementById("methods"), "Main"));
    }

    function generateSections(contracts){
        let outerMethods = document.getElementById("methods");
        contracts.forEach(contract => {
            let panel = document.createElement("div");
            panel.classList.add("collapsed", "panel", "panel-default");
            let panelHead = document.createElement("div");
            panelHead.classList.add("panel-heading");
            panelHead.setAttribute("role", "tab");
            let caller = document.createElement("a");
            caller.classList.add("collapsed");
            caller.setAttribute("role", "button");
            caller.setAttribute("onclick", "$('#"+contract[0]+"').collapse('toggle')");
            caller.innerHTML = contract[0];
            panelHead.appendChild(caller);
            panel.appendChild(panelHead);
            let elem = document.createElement("div");
            elem.classList.add("collapse");
            elem.id = contract[0];
            jsonABI = JSON.parse(contract[1]);
            console.log(elem.id + ": " + jsonABI);
            jsonABI.forEach(method => generateCaller(method, elem, contract[0]));
            panel.appendChild(elem);
            outerMethods.appendChild(panel);
        })

    }

    function generateCaller(method, container, cname) {
        let elem = document.createElement("div");
        let text = method.name + ": ";
        elem.appendChild(document.createTextNode(text));
        method.inputs.forEach(param => elem.appendChild(generateInput(method.name, param.name, param.type)));
        method.outputs.forEach(o => {
            let out = document.createElement("label");
            out.id = "OUT_"+method.name+"_"+cname;
            elem.appendChild(out);
        });

        let caller = document.createElement("input");
        caller.type = "button";
        caller.value = method.name;
        caller.setAttribute("onclick", "callMethod('" + cname + "', '" + method.name + "');");
        elem.appendChild(caller);

        container.appendChild(elem);
    }

    function callMethod(cname, method){
        let contract = contracts[cname];
        let abi = contract.ABI;
        let addr = contract.address;
        let args = [];
        let contr = new web3.eth.Contract(abi, addr);
        abi.find(e => e.name === method).inputs.forEach(i => args.push(document.getElementById(method+"_"+i.name).value));
        if (abi.find(e => e.name === method).stateMutability === "view"){
            contr.methods[method].apply(null, args).call().then(Result => {
                console.log("OUT_"+method+"_"+Result.name);
                console.log(Result);
                document.getElementById("OUT_"+method+"_"+cname).innerHTML = Result});
        } else {
            contr.methods[method].apply(null, args).send({from: callerAddr, gasPrice: 1});
        }
    }

    function showAccounts() {
        web3.eth.getAccounts().then(function (accounts) {
            console.log(accounts);
            let elem = document.createElement("tbody");
            elem.id = "accounts-list";
            elem.className = "list-group";
            for (acc in accounts) {
                let accountElem = document.createElement("tr");
                let counter = document.createElement("th");
                counter.scope = "row";
                counter.innerHTML = acc;
                accountElem.appendChild(counter);
                let name = document.createElement("td");
                name.innerHTML = accounts[acc];
                accountElem.appendChild(name);
                let balance = document.createElement("td");
                web3.eth.getBalance(accounts[acc]).then(function (result) {
                    balance.innerHTML = result;
                });
                accountElem.appendChild(balance);
                elem.appendChild(accountElem);
            }
            let outer = document.getElementById('accounts-list');
            let elems = document.getElementById("account-body");
            elems.remove();
            outer.appendChild(elem);
        });
    }


    showAccounts();

</script>
</html>